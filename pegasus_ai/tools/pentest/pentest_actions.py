"""
Advanced penetration testing actions for Pegasus AI
"""

import json
import logging
from typing import Any

from pegasus_ai.tools.registry import register_tool


logger = logging.getLogger(__name__)


@register_tool
def run_nmap_scan(
    target: str,
    scan_type: str = "basic",
    ports: str = "1-1000",
) -> dict[str, Any]:
    """
    Run Nmap port scanning against a target.

    Args:
        target: Target IP address or hostname
        scan_type: Type of scan - 'basic', 'aggressive', 'stealth', or 'full'
        ports: Port range to scan (e.g., '1-1000', '80,443', 'all')

    Returns:
        Dictionary containing scan results
    """
    scan_options = {
        "basic": "-sV -sC",
        "aggressive": "-A -T4",
        "stealth": "-sS -T2",
        "full": "-A -p- -T4",
    }

    nmap_args = scan_options.get(scan_type, "-sV")
    if ports != "all" and scan_type != "full":
        nmap_args += f" -p {ports}"

    command = f"nmap {nmap_args} {target}"

    return {
        "tool": "nmap_scan",
        "command": command,
        "target": target,
        "scan_type": scan_type,
        "status": "configured",
        "note": "Execute this command in terminal to perform the scan",
    }


@register_tool
def run_nuclei_scan(
    target: str,
    severity: str = "critical,high,medium",
    templates: str = "all",
) -> dict[str, Any]:
    """
    Run Nuclei vulnerability scanner against a target.

    Args:
        target: Target URL to scan
        severity: Severity levels to scan for (critical, high, medium, low, info)
        templates: Template categories to use ('all', 'cves', 'misconfigurations', etc.)

    Returns:
        Dictionary containing scan configuration
    """
    command = f"nuclei -u {target} -severity {severity}"

    if templates != "all":
        command += f" -tags {templates}"

    command += " -json -o nuclei_results.json"

    return {
        "tool": "nuclei_scan",
        "command": command,
        "target": target,
        "severity": severity,
        "templates": templates,
        "status": "configured",
        "note": "Execute this command in terminal to perform the scan",
    }


@register_tool
def run_sqlmap_attack(
    target_url: str,
    cookie: str = "",
    data: str = "",
    method: str = "GET",
    level: int = 1,
    risk: int = 1,
) -> dict[str, Any]:
    """
    Run SQLMap to test for SQL injection vulnerabilities.

    Args:
        target_url: Target URL to test
        cookie: Cookie string if authentication is required
        data: POST data if testing POST parameters
        method: HTTP method (GET or POST)
        level: SQLMap level (1-5, higher is more thorough)
        risk: SQLMap risk (1-3, higher tests more payloads)

    Returns:
        Dictionary containing attack configuration
    """
    command = f"sqlmap -u '{target_url}' --level={level} --risk={risk} --batch"

    if cookie:
        command += f" --cookie='{cookie}'"

    if data and method.upper() == "POST":
        command += f" --data='{data}'"

    command += " --output-dir=/workspace/sqlmap_output"

    return {
        "tool": "sqlmap_attack",
        "command": command,
        "target": target_url,
        "method": method,
        "level": level,
        "risk": risk,
        "status": "configured",
        "warning": "Only test on authorized targets!",
        "note": "Execute this command in terminal to perform the attack",
    }


@register_tool
def run_subdomain_enum(
    domain: str,
    tool: str = "subfinder",
) -> dict[str, Any]:
    """
    Enumerate subdomains for a target domain.

    Args:
        domain: Target domain (e.g., example.com)
        tool: Tool to use ('subfinder', 'amass', 'assetfinder')

    Returns:
        Dictionary containing enumeration configuration
    """
    commands = {
        "subfinder": f"subfinder -d {domain} -o subdomains.txt",
        "amass": f"amass enum -d {domain} -o subdomains.txt",
        "assetfinder": f"assetfinder --subs-only {domain} | tee subdomains.txt",
    }

    command = commands.get(tool, commands["subfinder"])

    return {
        "tool": "subdomain_enum",
        "command": command,
        "domain": domain,
        "enum_tool": tool,
        "status": "configured",
        "note": "Execute this command in terminal to enumerate subdomains",
    }


@register_tool
def run_vulnerability_scan(
    target: str,
    scan_profile: str = "comprehensive",
    output_format: str = "json",
) -> dict[str, Any]:
    """
    Run a comprehensive vulnerability scan using multiple tools.

    Args:
        target: Target URL or IP to scan
        scan_profile: Scan profile - 'quick', 'standard', 'comprehensive', or 'deep'
        output_format: Output format - 'json', 'html', or 'markdown'

    Returns:
        Dictionary containing scan orchestration plan
    """
    scan_plans = {
        "quick": [
            "Run Nmap basic scan on common ports",
            "Run Nuclei with critical templates only",
            "Check for common misconfigurations",
        ],
        "standard": [
            "Run Nmap service detection",
            "Run Nuclei with critical and high severity templates",
            "Test for OWASP Top 10 vulnerabilities",
            "Check SSL/TLS configuration",
        ],
        "comprehensive": [
            "Run Nmap aggressive scan",
            "Run Nuclei with all severity levels",
            "Test for OWASP Top 10 vulnerabilities",
            "Run SQLMap on identified parameters",
            "Check for security header misconfigurations",
            "Scan for exposed secrets and credentials",
            "Test authentication mechanisms",
        ],
        "deep": [
            "Run full port Nmap scan",
            "Run Nuclei with all templates",
            "Comprehensive OWASP Top 10 testing",
            "Advanced SQLMap testing",
            "Business logic vulnerability testing",
            "API security testing",
            "Session management testing",
            "Authorization testing",
        ],
    }

    plan = scan_plans.get(scan_profile, scan_plans["standard"])

    return {
        "tool": "vulnerability_scan",
        "target": target,
        "scan_profile": scan_profile,
        "output_format": output_format,
        "scan_plan": plan,
        "estimated_duration": {
            "quick": "5-10 minutes",
            "standard": "15-30 minutes",
            "comprehensive": "30-60 minutes",
            "deep": "1-3 hours",
        }.get(scan_profile, "Unknown"),
        "status": "planned",
        "note": "Execute the scan plan steps sequentially using appropriate tools",
    }
